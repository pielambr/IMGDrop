window.onload=function(){IMGDrop.init()};
var IMGDrop={resetCrop:function(){this.coords.x1=0;this.coords.x2=0;this.coords.y1=0;this.coords.y2=0;this.drawSelection()},applyCrop:function(){if(0===Object.keys(this.coords).length||0===this.coords.x1&&0===this.coords.x2&&0===this.coords.y1&&0===this.coords.y2)this.upload(this.image);else{var a=document.createElement("canvas"),b=Math.abs(this.coords.x2-this.coords.x1),c=Math.abs(this.coords.y2-this.coords.y1);a.width=b;a.height=c;var d=a.getContext("2d"),e=document.getElementsByTagName("img")[0];
    d.drawImage(e,Math.min(this.coords.x1,this.coords.x2),Math.min(this.coords.y1,this.coords.y2),b,c,0,0,b,c);this.upload(this.dataToBlob(a.toDataURL()))}},addCropMenu:function(){var a=this,b=document.createElement("div");b.style.position="fixed";b.style.background="rgba(0, 0, 0, 0.5)";b.style.right="0px";b.style.top="0px";var c=document.createElement("input");c.style.margin="5px";c.type="submit";c.value="Apply";c.onclick=function(){a.applyCrop()};var d=document.createElement("input");d.style.margin=
    "5px";d.type="submit";d.value="Reset";d.onclick=function(){a.resetCrop()};b.appendChild(c);b.appendChild(d);document.getElementsByTagName("body")[0].appendChild(b)},drawImage:function(a){var b=document.getElementsByTagName("body")[0];b.innerHTML="";a=(window.URL||window.webkitURL).createObjectURL(a);var c=new Image;c.src=a;c.onmousedown=function(){return!1};b.appendChild(c);this.selection=document.createElement("div");this.selection.style.position="absolute";this.selection.style.border="2px red solid";
    b.appendChild(this.selection)},drawSelection:function(){var a=document.getElementsByTagName("body")[0];a.removeChild(this.selection);var b=Math.abs(this.coords.x2-this.coords.x1),c=Math.abs(this.coords.y2-this.coords.y1),d=Math.min(this.coords.x1,this.coords.x2),e=Math.min(this.coords.y1,this.coords.y2);this.selection.style.left=d+"px";this.selection.style.top=e+"px";this.selection.style.width=b+"px";this.selection.style.height=c+"px";a.appendChild(this.selection)},prepareCrop:function(a){var b=this;
    this.image=a;this.drawImage(a);this.addCropMenu();this.can_upload=!1;var c=document.getElementsByTagName("img")[0];c.onmousedown=function(a){b.coords.x1=window.pageXOffset+a.clientX;b.coords.y1=window.pageYOffset+a.clientY;c.onmousemove=function(a){b.coords.x2=window.pageXOffset+a.clientX;b.coords.y2=window.pageYOffset+a.clientY;b.drawSelection()};return!1};c.onmouseup=function(a){c.onmousemove=null};document.onkeydown=function(a){13===(a.which||a.keyCode)&&b.applyCrop()}},dataToBlob:function(a){var b=
    atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var c=new Uint8Array(b.length),d=0;d<b.length;d++)c[d]=b.charCodeAt(d);return new Blob([c],{type:a})},addPasteRegio:function(){var a=this;this.regio=document.createElement("div");this.regio.setAttribute("contenteditable","");this.regio.setAttribute("position","absolute");this.regio.setAttribute("left","-999px");this.regio.style.opacity=0;document.body.appendChild(this.regio);this.regio.focus();document.addEventListener("click",
    function(){a.can_upload&&a.regio.focus()})},paste:function(a){var b=this;a=a.clipboardData||window.clipboardData;a.items?a.items[0]&&-1!==a.items[0].type.indexOf("image/")&&(a=a.items[0].getAsFile())&&this.prepareCrop(a):setTimeout(function(){b.checkPasteRegio()},1)},checkPasteRegio:function(){var a=this.regio.childNodes[0];this.regio.innerHTML="";a&&"IMG"===a.tagName&&(blob=this.dataToBlob(a.src),this.prepareCrop(blob))},upload:function(a){var b=this.progress,c=a?new FormData:new FormData(this.form);
    a&&c.append("file",a,"screenshot.png");var d=new XMLHttpRequest;d.open("POST","upload.php");d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status){var a=JSON.parse(this.responseText);window.location="view.php?"+a.name}else 413===d.status?alert("File is too big, please try a smaller file!"):alert("An unknown error happened while uploading your file")};d.upload.onprogress=function(a){a.lengthComputable&&(b.value=parseInt(a.loaded/a.total*100))};d.upload.onload=function(a){b.value=100};
    d.send(c)},init:function(){var a=this;this.coords={};this.can_upload=!0;this.progress=document.getElementById("progress");if(this.form=document.getElementById("file_form"))this.form.onsubmit=function(b){b.preventDefault();a.prepareCrop()};document.addEventListener("paste",function(b){a.paste(b)});this.addPasteRegio()}};