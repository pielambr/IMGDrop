window.onload=function(){IMGDrop.init()};var IMGDrop={resetCrop:function(){this.coords.x1=0;this.coords.x2=0;this.coords.y1=0;this.coords.y2=0;this.drawSelection()},applyCrop:function(){if(Object.keys(this.coords).length===0||(this.coords.x1===0&&this.coords.x2===0&&this.coords.y1===0&&this.coords.y2===0)){this.upload(this.image);return}else{var c=document.createElement("canvas");var d=Math.abs(this.coords.x2-this.coords.x1);var a=Math.abs(this.coords.y2-this.coords.y1);c.width=d;c.height=a;var b=c.getContext("2d");var e=document.getElementsByTagName("img")[0];b.drawImage(e,Math.min(this.coords.x1,this.coords.x2),Math.min(this.coords.y1,this.coords.y2),d,a,0,0,d,a);this.upload(this.dataToBlob(c.toDataURL()))}},addCropMenu:function(){var c=this;var d=document.createElement("div");d.style.position="fixed";d.style.background="rgba(0, 0, 0, 0.5)";d.style.right="0px";d.style.top="0px";var a=document.createElement("input");a.style.margin="5px";a.type="submit";a.value="Apply";a.onclick=function(){c.applyCrop()};var b=document.createElement("input");b.style.margin="5px";b.type="submit";b.value="Reset";b.onclick=function(){c.resetCrop()};d.appendChild(a);d.appendChild(b);document.getElementsByTagName("body")[0].appendChild(d)},drawImage:function(d){var a=document.getElementsByTagName("body")[0];a.innerHTML="";var e=window.URL||window.webkitURL;var c=e.createObjectURL(d);var b=new Image();b.src=c;b.onmousedown=function(){return false};a.appendChild(b);this.selection=document.createElement("div");this.selection.style.position="absolute";this.selection.style.border="2px red solid";a.appendChild(this.selection)},drawSelection:function(){var c=document.getElementsByTagName("body")[0];c.removeChild(this.selection);var d=Math.abs(this.coords.x2-this.coords.x1);var b=Math.abs(this.coords.y2-this.coords.y1);var a=Math.min(this.coords.x1,this.coords.x2);var e=Math.min(this.coords.y1,this.coords.y2);this.selection.style.left=a+"px";this.selection.style.top=e+"px";this.selection.style.width=d+"px";this.selection.style.height=b+"px";c.appendChild(this.selection)},prepareCrop:function(c){var b=this;this.image=c;this.drawImage(c);this.addCropMenu();this.can_upload=false;var a=document.getElementsByTagName("img")[0];a.onmousedown=function(d){b.coords.x1=d.clientX;b.coords.y1=d.clientY;a.onmousemove=function(e){b.coords.x2=e.clientX;b.coords.y2=e.clientY;b.drawSelection()};return false};a.onmouseup=function(d){a.onmousemove=null};document.onkeydown=function(e){var d=e.which||e.keyCode;if(d===13){b.applyCrop()}}},dataToBlob:function(b){var e=atob(b.split(",")[1]);var a=b.split(",")[0].split(":")[1].split(";")[0];var c=new Uint8Array(e.length);for(var d=0;d<e.length;d++){c[d]=e.charCodeAt(d)}return new Blob([c],{type:a})},addPasteRegio:function(){var a=this;this.regio=document.createElement("div");this.regio.setAttribute("contenteditable","");this.regio.setAttribute("position","absolute");this.regio.setAttribute("left","-999px");this.regio.style.opacity=0;document.body.appendChild(this.regio);this.regio.focus();document.addEventListener("click",function(){if(a.can_upload){a.regio.focus()}})},paste:function(b){var a=this;var c=b.clipboardData||window.clipboardData;if(c.items){if(c.items[0]&&c.items[0].type.indexOf("image/")!==-1){var d=c.items[0].getAsFile();if(d){this.prepareCrop(d)}}}else{setTimeout(function(){a.checkPasteRegio()},1)}},checkPasteRegio:function(){var a=this.regio.childNodes[0];this.regio.innerHTML="";if(a&&a.tagName==="IMG"){blob=this.dataToBlob(a.src);this.prepareCrop(blob)}},upload:function(d){var a=this.progress;var c=d?new FormData():new FormData(this.form);if(d){c.append("file",d,"screenshot.png")}var b=new XMLHttpRequest();b.open("POST","upload.php");b.onreadystatechange=function(){if(b.readyState===4){if(b.status===200){var e=JSON.parse(this.responseText);window.location="view.php?"+e.name}else{if(b.status===413){alert("File is too big, please try a smaller file!")}else{alert("An unknown error happened while uploading your file")}}}};b.upload.onprogress=function(f){if(f.lengthComputable){var e=f.loaded/f.total;a.value=parseInt(e*100)}};b.upload.onload=function(e){a.value=100};b.send(c)},init:function(){var a=this;this.coords={};this.can_upload=true;this.progress=document.getElementById("progress");this.form=document.getElementById("file_form");if(this.form){this.form.onsubmit=function(b){b.preventDefault();a.prepareCrop()}}document.addEventListener("paste",function(b){a.paste(b)});this.addPasteRegio()}};
